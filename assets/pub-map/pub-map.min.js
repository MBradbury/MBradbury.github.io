function linkArc(t){const e=Math.hypot(t.target.x-t.source.x,t.target.y-t.source.y);return`\n    M${t.source.x},${t.source.y}\n    A${e},${e} 0 0,1 ${t.target.x},${t.target.y}\n  `}function drag(t){return d3.drag().on("start",function(e,a){e.active||t.alphaTarget(.3).restart(),a.fx=a.x,a.fy=a.y}).on("drag",function(t,e){e.fx=t.x,e.fy=t.y}).on("end",function(e,a){e.active||t.alphaTarget(0),a.fx=null,a.fy=null})}function make_legend(t,e,a){const r=d3.select("#"+t).append("svg").attr("width",a).attr("height",50).attr("viewBox",[0,0,a,50]).style("overflow","visible").style("display","block"),n=d3.scaleBand().domain(e.domain()).rangeRound([0,a-0]);r.append("g").selectAll("rect").data(e.domain()).join("rect").attr("x",n).attr("y",18).attr("width",Math.max(0,n.bandwidth()-1)).attr("height",10).attr("fill",e),r.append("g").attr("transform","translate(0,28)").call(d3.axisBottom(n).tickSize(6)).call(t=>t.select(".domain").remove())}function make_graph(t,e,a,r,n,o){const i=r.links,l=r.nodes,d=r.publications,c=d3.forceSimulation(l).force("link",d3.forceLink(i).id(t=>t.id).distance(20).strength(.5)).force("charge",d3.forceManyBody().strength(-400)).force("x",d3.forceX()).force("y",d3.forceY()).force("collide",d3.forceCollide().radius(50).iterations(4)).force("center",d3.forceCenter(o/2,n/2)).force("boundary",forceBoundary(0,0,o,n)),s=d3.select("#"+t).append("svg").attr("viewBox",[0,0,o,n]).attr("class","publication_map").attr("xlink","http://www.w3.org/1999/xlink");s.append("defs").selectAll("marker").data(e).join("marker").attr("id",t=>`arrow-${t}`).attr("viewBox","0 -5 10 10").attr("refX",15).attr("refY",-.5).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").append("path").attr("fill",a).attr("d","M0,-5L10,0L0,5");const p=s.append("g").attr("fill","none").attr("stroke-width",3).selectAll("path").data(i).join("path").attr("stroke",t=>a(t.type)).attr("marker-end",t=>`url(${new URL(`#arrow-${t.type}`,location)})`),f=s.append("g").attr("fill","currentColor").attr("stroke-linecap","round").attr("stroke-linejoin","round").selectAll("g").data(l).join("g").call(drag(c));f.append("a").attr("xlink:href",t=>"#"+d.filter(e=>e.ident==t.id).map(t=>t.key)).append("text").style("text-anchor","middle").text(t=>t.id).clone(!0).lower().attr("fill","none").attr("stroke","white").attr("stroke-width",5),c.on("tick",()=>{p.attr("d",linkArc),f.attr("transform",t=>`translate(${t.x},${t.y})`)})}function make_publication_map(t){const e=document.getElementById(t).offsetWidth;d3.json("/assets/pub-map/publications.json").then(a=>{const r=new Set(a.relations.map(t=>t.type)),n=new Set(a.publications.map(t=>t.ident)),o=d3.scaleOrdinal(r,d3.schemeCategory10),i={nodes:Array.from(n,t=>({id:t})),links:a.relations,publications:a.publications};make_legend(t,o,e),make_graph(t,r,o,i,650,e)})}